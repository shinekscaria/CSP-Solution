<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Offers</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>

<body class="bg-light">
<div class="container py-4">

  <h3>Offers</h3>

  <div class="d-flex gap-2 my-3">
    <a href="index.html" class="btn btn-secondary">Back</a>

    <!-- Upload Offers CSV -->
    <input id="offerCsvFile" type="file" accept=".csv" class="form-control" style="max-width:300px;">
    <button id="uploadOfferBtn" class="btn btn-primary">Upload Offers CSV</button>
  </div>

  <div id="offerUploadStatus"></div>

  <table class="table table-bordered mt-3" id="offerTbl">
    <thead class="table-dark">
      <tr>
        <th>Code</th>
        <th>Title</th>
        <th>Description</th>
        <th>Eligibility</th>
        <th>Active</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// --------------------- LOAD OFFERS ---------------------
async function loadOffers() {
  const res = await fetch("/api/offers");
  const data = await res.json();
  const tbody = document.querySelector("#offerTbl tbody");
  tbody.innerHTML = "";

  data.forEach(o => {
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${o.code}</td>
      <td>${o.title}</td>
      <td>${o.description || ""}</td>
      <td>${o.eligibility_simple || ""}</td>
      <td>${o.active ? "Yes" : "No"}</td>
    `;
    tbody.appendChild(tr);
  });
}


// --------------------- UPLOAD OFFERS CSV ---------------------
document.getElementById("uploadOfferBtn").addEventListener("click", async () => {
  const f = document.getElementById("offerCsvFile").files[0];
  if (!f) { alert("Please select an offers CSV file."); return; }

  const csvText = await f.text();

  const res = await fetch("/api/offers/upload", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ csv: csvText })
  });

  const j = await res.json();

  document.getElementById("offerUploadStatus").innerHTML = `
    <div class="alert alert-info">
      Inserted: ${j.inserted} <br>
      Errors: ${j.errors.length}
    </div>
  `;

  loadOffers();
});


// Load offers on page load
loadOffers();
</script>

</body>
</html>
